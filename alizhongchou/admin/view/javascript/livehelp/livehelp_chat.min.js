var LivehelpChat={setting:{sound:1,soundFolder:"../image/sounds/",soundAlert:{newMessage:null,messageSent:null,userLogged:null,userLogout:null,special:null},smiley:0,textMaxLength:500,ajaxUrl:null,timeout:5e3,languageId:1,languageCode:"en",saveOpened:!1},language:{en:{text_operator_signed:"Operator has joined into your chat",text_username:"Username:",text_ip:"IP address:",text_user_agent:"User agent:",text_referer:"Referer:",text_customer:"Customer:",text_registred:"Registred user",text_not_registred:"Visitor",text_date_added:"Date added:",text_closed:"Closed",text_ban_success:"user was successfuly banned!",text_last_activity:"Last activity:",text_before:"Before",text_user_away:"User is already %s long away or went offline",text_user_back_online:"User is again online",text_right_now:"Right now",text_user_cart:"Customer Cart",text_cart_items:"item(s)",text_cart_total:"Cart total",text_in_stock:"In Stock",text_out_stock:"Out Stock",text_product_id:"Product ID",text_product_name:"Name",text_product_qty:"Quantity",text_empty_cart:"Customer's shopping cart is empty"}},threads:{},onBootUpdated:0,timer:null,openThread:[],init:function(e,t,s){"undefined"!=typeof e.lastReaded&&(this.lastReadedId=e.lastReaded),this.setting=$.extend({},this.setting,e||{}),this.threads=$.extend({},this.threads,t||{}),this.language=$.extend({},this.language,s||{});try{this.initSessionVariables(),this.initEventListener(),this.verifyInit(),this.onBootUpdated||(this.makeRequest(null),this.onBootUpdated=1),this.startTimer()}catch(a){console.log(a)}},initSessionVariables:function(){if(null!==localStorage.getItem("sound")&&(this.setting.sound=parseInt(localStorage.getItem("sound")),this.setting.sound?$("#livehelp-sound-toggle i").removeClass("icon-volume-mute").addClass("icon-volume-high"):$("#livehelp-sound-toggle i").removeClass("icon-volume-high").addClass("icon-volume-mute")),this.setting.saveOpened&&null!==localStorage.getItem("openThread")){this.openThread=localStorage.getItem("openThread").split(",");for(var e in this.openThread)$("#lh-name-"+this.openThread[e]+" a").trigger("click")}},verifyInit:function(){if(!this.setting.ajaxUrl||this.setting.timeout<1e3)throw new Error("Major variables not specified!");if(this.setting.soundAlert.newMessage||this.setting.soundAlert.messageSent||this.setting.soundAlert.userLogged||this.setting.soundAlert.userLogout||this.setting.soundAlert.special||(this.setting.sound=0,localStorage.removeItem("sound")),"undefined"==typeof this.language[this.setting.languageCode])throw new Error("Unsupported language code")},getLang:function(e,t){return this.language[this.setting.languageCode][e]?t?this.language[this.setting.languageCode][e].replace("%s",t):this.language[this.setting.languageCode][e]:e},startTimer:function(){var e=this,t=0;e.timer=setInterval(function(){t||e.makeRequest(null),t++},e.setting.timeout)},initEventListener:function(){var e=this;$("#lh-popup").delegate(".lh-textarea-input","keydown",function(t){var s=$(this);if(13==t.keyCode&&t.shiftKey){var a=s.val();s.value=a+"\n",e.changeTextareaHeight(s),t.stopPropagation()}else if(13==t.keyCode||10==t.keyCode){if(t.preventDefault(),!s.val().replace("\n","").trim().length)return!1;e.makeRequest("new_msg",{msg_thread_id:parseInt(s.attr("name")),msg_text:s.val()}),e.clearText(s)}else if(this.clientHeight<this.scrollHeight&&e.changeTextareaHeight(s),e.setting.textMaxLength&&s.val().length>e.setting.textMaxLength)return void s.val(s.val().substr(0,e.setting.textMaxLength))}).delegate(".lh-thread-get-info","click",function(t){e.getTreadInfo(parseInt($(this).closest(".popup-box").data("thread-id")))}),$("#lh-name-list").delegate(".lh-name > a","click",function(){var t=parseInt($(this).data("thread-id")),s=null,a={};$(this).hasClass("lh-new-msg")&&(!e.threads[t].last_id||e.threads[t].last_id>e.threads[t].operator_readed)&&(s="update_readed",a.update_readed_thread=t,a.update_readed_id=e.threads[t].last_id),e.setThreadOpen(t),e.removeActiveThreadNode(t),e.makeRequest(s,a)}),$("#lh-popup").delegate(".popup-box-active","click",function(){var t=parseInt($(this).data("thread-id")),s={};s.update_readed_thread=t,s.update_readed_id=e.threads[t].last_id,e.removeActiveThreadNode(t),e.makeRequest("update_readed",s)})},logout:function(){$.post(this.setting.ajaxUrl,{operation:"signout"},function(){location.reload()},"json")},toggleOperator:function(e){if(e.value){$(e).closest(".dropdown").trigger("click");var t={toggle_operator:{operator_id:e.value,thread_id:$(e).closest(".popup-box").data("thread-id")}};this.makeRequest("toggle_operator",t),this.closeThread(t.toggle_operator.thread_id),$(e).closest(".dropdown").remove()}},insertAction:function(e,t,s){var a,r=this,d=parseInt($(e).closest(".popup-box").data("thread-id"));switch("undefined"==typeof s&&(s={}),t){case"kick":a="action_kick",s.kicked_thread_id=d,r.makeRequest(a,s);break;case"ban":a="action_ban",s.baned_thread_id=d,str=prompt(r.getLang("entry_comment"),""),str?s.baned_comment=str:s.baned_comment="",r.makeRequest(a,s);break;case"remove":if(!r.threads[d].date_closed)return;a="action_remove",s.remove_thread_id=d,r.makeRequest(a,s),r.removeThread(d),r.playSound("removed");break;default:a=t,r.makeRequest(a,s)}},makeRequest:function(e,t){var s=this;"undefined"==typeof t&&(t=new Object),clearInterval(s.timer),s.timer=null,t.operation=e||null;try{t.threads=new Array;for(var a in s.openThread){var r,d=parseInt(s.openThread[a]);r={thread_id:d,last_id:s.threads[d].last_id},t.threads.push(r)}$.post(this.setting.ajaxUrl,t,function(e){if(e.error)throw new Error(e.error);for(var t in e.threads){var a=0;"undefined"==typeof s.threads[t]?s.addThread(e.threads[t]):(s.threads[t].operator_readed=parseInt(e.threads[t].operator_readed),s.threads[t].ping_diff=parseInt(e.threads[t].ping_diff),s.threads[t].user_cart=e.threads[t].user_cart,s.threads[t].is_online!=parseInt(e.threads[t].is_online)&&s.setThreadState(t,parseInt(e.threads[t].is_online)),parseInt(e.threads[t].date_closed)&&(s.closeThread(t),s.threads[t].date_closed=parseInt(e.threads[t].date_closed))),parseInt(e.threads[t].total_new)&&s.setActiveThreadNode(t,parseInt(e.threads[t].total_new))}if(e.messages)for(var r in e.messages){for(var d in e.messages[r]){var i=e.messages[r][d],n=!1;!n&&"1"==i.initiator&&i.message_id>s.threads[r].operator_readed&&(n=!0),s.insertMessage(r,i.message,parseInt(i.initiator),i.date_added,n),a=parseInt(i.message_id)}a>s.threads[r].last_id&&(s.threads[r].last_id=a)}e.success&&alert(e.success)},"json"),"new_msg"==e&&s.playSound("msg_sent")}catch(i){console.log(i)}this.startTimer()},addThread:function(e){var t=[];this.threads[e.thread_id]={username:e.user_name,customer_id:e.customer_id,customer_link:e.customer_link,date_added:e.date_added,date_modified:e.date_modified,date_closed:parseInt(e.date_closed),operator_readed:parseInt(e.operator_readed),last_id:0,user_ip:e.user_ip,user_agent:e.user_agent,user_cart:e.user_cart,referer:e.referer,language_id:e.language_id,ping_diff:parseInt(e.ping_diff),is_online:e.is_online},parseInt(e.customer_id)&&t.push("lh-registred"),$("#lh-name-list").responsivebar("addNode",{id:e.thread_id,name:e.user_name,nodeClass:t}),this.playSound("user_join")},removeThread:function(e){$("#lh-name-list").responsivebar("removeNode",{id:e}),$("#lh-thread-popup-"+e).remove()},setThreadOpen:function(e){-1===this.openThread.indexOf(e)&&(this.openThread.push(e),this.setting.saveOpened&&localStorage.setItem("openThread",this.openThread.join(",")))},setActiveThreadNode:function(e,t){t||(t="");var s=$("#lh-name-"+e);s.children("a").addClass("lh-new-msg"),t&&s.children("a").children("span").text("("+t+")"),$("#lh-thread-popup-"+e).length&&$("#lh-thread-popup-"+e).addClass("popup-box-active").find(".popup-head .badge").text(t)},removeActiveThreadNode:function(e){$("#lh-name-"+e+" a").removeClass("lh-new-msg").children("span").text(""),$("#lh-thread-popup-"+e).removeClass("popup-box-active").find(".popup-head .badge").text("")},getTreadInfo:function(e){var t="";if(t+='<div class="modal fade" id="lh-modal-dialog-modal" tabindex="-1" role="dialog">',t+='<div class="modal-dialog" role="document">',t+='<div class="modal-content">',t+='<div class="modal-header">',t+='<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>',t+='<h4 class="modal-title" id="exampleModalLabel">'+this.threads[e].username+"</h4>",t+="</div>",t+='<div class="modal-body">',t+='<dl class="lh-user-info well">',t+="<dt>"+this.getLang("text_username")+"</dt>",t+='<dd class="text-left">'+this.threads[e].username+"</dd>",t+="<dt>"+this.getLang("text_customer")+"</dt>",t+=this.threads[e].customer_link?'<dd class="text-left"><a href="'+this.threads[e].customer_link+'">'+this.getLang("text_registred")+"</a></dd>":'<dd class="text-left">'+this.getLang("text_not_registred")+"</dd>",t+="<dt>"+this.getLang("text_ip")+"</dt>",t+='<dd class="text-left">'+this.threads[e].user_ip+"</dd>",t+="<dt>"+this.getLang("text_date_added")+"</dt>",t+='<dd class="text-left">'+this.threads[e].date_added+"</dd>",t+="<dt>"+this.getLang("text_user_agent")+"</dt>",t+='<dd class="text-left">'+this.threads[e].user_agent+"</dd>",t+="<dt>"+this.getLang("text_referer")+"</dt>",t+='<dd class="text-left">'+this.threads[e].referer+"</dd>",t+="<dt>"+this.getLang("text_last_activity")+"</dt>",t+=this.threads[e].ping_diff?'<dd class="text-left">'+this.getLang("text_before")+" "+this.mkDiffTime(this.threads[e].ping_diff)+"</dd>":'<dd class="text-left">'+this.getLang("text_right_now")+"</dd>",t+="</dl>",this.threads[e].user_cart){if(t+="<hr>",t+='<h4><i class="icon-cart"></i> '+this.getLang("text_user_cart")+' <small class="label label-danger">'+this.threads[e].user_cart.items+" "+this.getLang("text_cart_items")+" - "+this.threads[e].user_cart.total+"</small></h4>",t+='<table class="table table-hover">',t+="	<thead>",t+="		<tr>",t+="			<th>"+this.getLang("text_product_id")+"</th>",t+="			<th>"+this.getLang("text_product_name")+"</th>",t+="			<th>"+this.getLang("text_product_qty")+"</th>",t+="		</tr>",t+="	</thead>",t+="	<tbody>",this.threads[e].user_cart.items)for(var s in this.threads[e].user_cart.products){var a=this.threads[e].user_cart.products[s];t+="		<tr>",t+="			<td>"+s+"</td>",t+="			<td>"+a.name+" "+(parseInt(a.stock)?'<span class="label label-success">'+this.getLang("text_in_stock")+"</span>":'<span class="label label-danger">'+this.getLang("text_out_stock")+"</span>")+"</td>",t+="			<td>"+a.qty+"</td>",t+="		</tr>"}else t+='  <tr><td colspan="3" class="text-center">'+this.getLang("text_empty_cart")+"</td></tr>";t+="	</tbody>",t+="</table>"}t+="</div>",t+="</div>",t+="</div>",t+="</div>",$("#lh-modal-dialog").html(t),$("#lh-modal-dialog-modal").modal()},closeThread:function(e){var t=this.openThread.indexOf(parseInt(e));-1!==t&&this.openThread.splice(t,1),$("#lh-thread-popup-"+e).addClass("lh-closed-thread").find(".popup-head .badge").text(this.getLang("text_closed"))},setThreadState:function(e,t){if(t){var s=this;$("#lh-name-"+e+" a").removeClass("lh-closed");var a=s.getLang("text_user_back_online");this.insertMessage(e,a,3),this.playSound("user_join")}else{var s=this;$("#lh-name-"+e+" a").addClass("lh-closed");var a=s.getLang("text_user_away",s.mkDiffTime(s.threads[e].ping_diff));this.insertMessage(e,a,3),this.playSound("user_leave")}s.threads[e].is_online=t},mkDiffTime:function(e){var t="",s=parseInt(e),a=Math.floor(s/60/60);s-=60*a*60;var r=Math.floor(s/60);s-=60*r;var d=Math.floor(s);return s-=d,a&&(t+=a+"h "),r&&(t+=r+"m "),d&&(t+=d+"s "),t||0},insertMessage:function(e,t,s,a,r){var d,i="",n=$("#lh-thread-popup-"+e+" .popup-messages");if(n.length){switch(s){case 1:d="received";break;case 2:d="sent";break;default:d="bot-generated"}i+='<div class="msg msg-'+d+'">',"undefined"!=typeof a&&(i+=' <div class="msg-head">',i+=' <span class="msg-date">'+a+"</span>",i+=" </div>"),i+=' <div class="msg-body">',i+=t.replace("\n","<br>"),i+=" </div>",i+="</div>",n.append(i),n.get(0).scrollTop=n.get(0).scrollHeight,r&&this.playSound("new_msg")}},changeTextareaHeight:function(e){var t=parseInt(e.css("height"));74>t&&e.css("height",t+20+"px")},insertText:function(e,t){var s=this.caretPos(e),a=e.val().substring(0,s),r=e.val().substring(s);e.val(a+" "+t+" "+r),e.focus()},insertEmoticon:function(e,t){var s=$(e).closest(".popup-input");this.insertText(s.find("textarea"),t),s.find(".lh-smiley-plugin").popover("hide")},insertBBCode:function(e,t){var s=this,a=$(e).closest(".popup-input").find("textarea");switch(t){case"url":str=prompt(s.getLang("text_entry_url"),"http://"),str&&s.insertText(a,"[url]"+str+"[/url]");break;case"youtube":str=prompt(s.getLang("text_entry_youtube"),"https://www.youtube.com/embed/"),str&&s.insertText(a,"[youtube]"+str+"[/youtube]");break;default:this.insertText(a,"["+t+"][/"+t+"]")}$(e).closest(".popup-input").find(".lh-bbcode-plugin").popover("hide")},clearText:function(e){e.val(""),e.css("height","34px")},caretPos:function(e){if("undefined"!=typeof e&&e.length){e=e[0];var t=0;if(document.selection){e.focus();var s=document.selection.createRange(),a=document.selection.createRange().text.length;s.moveStart("character",-e.value.length),t=s.text.length-a}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t}},loadSound:function(){var e=$("<audio></audio>");e.attr("id","lh-js-audio-block"),$("#livehelp").append(e)},playSound:function(e){if(this.setting.sound){$("#lh-js-audio-block").length||this.loadSound();var t=$("#lh-js-audio-block");try{switch(e){case"new_msg":if(!this.setting.soundAlert.newMessage)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.newMessage+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"msg_sent":if(!this.setting.soundAlert.messageSent)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.messageSent+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"user_join":if(!this.setting.soundAlert.userLogged)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.userLogged+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"user_leave":if(!this.setting.soundAlert.userLogout)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.userLogout+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"redirect":case"expirate":case"removed":if(!this.setting.soundAlert.special)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.special+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play()}}catch(s){console.log(s)}}},toggleSound:function(e){e.preventDefault(),e.stopPropagation(),null===localStorage.getItem("sound")?this.setting.sound=0:this.setting.sound=1===parseInt(localStorage.getItem("sound"))?0:1,localStorage.setItem("sound",this.setting.sound),$("#livehelp-sound-toggle i").toggleClass("icon-volume-high icon-volume-mute")}};