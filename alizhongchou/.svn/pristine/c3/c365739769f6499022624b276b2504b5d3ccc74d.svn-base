var LivehelpChat={setting:{sound:1,soundFolder:"image/sounds/",soundAlert:{newMessage:null,messageSent:null,operatorJoin:null,operatorLeave:null,special:null},textMaxLength:500,antiSpam:0,antiSpam_scoreLimit:10,antiSpam_penalty:60,antiSpam_range:20,ajaxUrl:null,timeout:5e3,languageId:1,languageCode:"en",customSlider:!1,titleAlert:!1},lastMsgId:0,lastReadedId:0,onBootUpdated:0,newMessageCount:0,pageTitleInterval:null,isOnline:0,timer:null,stopTimer:0,antiFlood:{score:0,lastact:null},language:{en:{text_operator_signed:"Operator has joined into your chat",text_operator_online_again:"Operator is again online",text_operator_away:"Operator is unavailable for some time or go offline",error_kicked:"You has been kicked from the chat!",text_muted_for_time:"You have been muted for the next %s seconds!",text_entry_url:"Entry link",text_entry_youtube:"Entry youtube embed link"}},temp:{page_title:"",operator:""},init:function(e,t){"undefined"!=typeof e.lastReaded&&(this.lastReadedId=e.lastReaded),"undefined"!=typeof e.isOnline&&(this.isOnline=e.isOnline),this.setting=$.extend({},this.setting,e||{}),this.language=$.extend({},this.language,t||{}),this.setting.customSlider=$(".lb-msg-wrapper[data-simplebar-direction]").length?$(".lb-msg-wrapper[data-simplebar-direction]"):!1,this.temp.page_title=document.title,this.temp.operator=$("h5.lh-oi-name").text();try{this.initSessionVariables(),this.initEventListener(),this.verifyInit(),this.onBootUpdated||(this.makeRequest(null),this.onBootUpdated=1),this.startTimer()}catch(s){console.log(s)}},initSessionVariables:function(){null!==localStorage.getItem("sound")&&(this.setting.sound=parseInt(localStorage.getItem("sound")),this.setting.sound?$(".lh-js-sound-toggle i").removeClass("icon1-volume-mute").addClass("icon1-volume-high"):$(".lh-js-sound-toggle i").removeClass("icon1-volume-high").addClass("icon1-volume-mute"))},verifyInit:function(){if(!this.setting.ajaxUrl||this.setting.timeout<1e3)throw new Error("Major variables not specified!");if(this.setting.soundAlert.newMessage||this.setting.soundAlert.messageSent||this.setting.soundAlert.operatorJoin||this.setting.soundAlert.operatorLeave||this.setting.soundAlert.special||(this.setting.sound=0,localStorage.removeItem("sound")),"undefined"==typeof this.language[this.setting.languageCode])throw new Error("Unsupported language code!")},getLang:function(e,t){return this.language[this.setting.languageCode][e]?t?this.language[this.setting.languageCode][e].replace("%s",t):this.language[this.setting.languageCode][e]:e},startTimer:function(){if(1!=this.stopTimer){var e=this,t=0;e.timer=setInterval(function(){t||e.makeRequest(null),t++},e.setting.timeout)}},initEventListener:function(){var e=this;$(".lh-textarea-input").on("keydown",function(t){var s=$(this);if(13==t.keyCode&&t.shiftKey){var a=s.val();s.value=a+"\n",e.changeTextareaHeight(s),t.stopPropagation()}else if(13==t.keyCode||10==t.keyCode){t.preventDefault();var n={};if(!s.val().replace("\n","").trim().length)return!1;if(e.setting.antiSpam){if(e.antiFlood.lastact||(e.antiFlood.lastact=(new Date).getTime()),e.antiFlood.score>=e.setting.antiSpam_scoreLimit&&(new Date).getTime()<e.antiFlood.lastact+1e3*e.setting.antiSpam_penalty)return void e.insertMessage('<span class="text-danger">'+e.getLang("text_muted_for_time",e.setting.antiSpam_penalty)+"</span>",3);(new Date).getTime()-e.antiFlood.lastact<1e3*e.setting.antiSpam_range?(e.antiFlood.score++,e.antiFlood.score==e.setting.antiSpam_scoreLimit&&(n.spamBlock=1)):(e.antiFlood.lastact=(new Date).getTime(),e.antiFlood.score=1)}n.lastId=e.lastMsgId,n.text=s.val(),e.makeRequest("new_msg",n),e.clearText($(".lh-textarea-input"))}else if(this.clientHeight<this.scrollHeight&&e.changeTextareaHeight(s),e.setting.textMaxLength&&s.val().length>e.setting.textMaxLength)return void s.val(s.val().substr(0,e.setting.textMaxLength))}),$("#livehelp").on("chatBox.focused",function(){var t=$(this);t.hasClass("lh-active-box")&&(e.removeNewStatus(),e.lastMsgId>e.lastReadedId&&(e.newMessageCount=0,e.lastReadedId=e.lastMsgId,e.makeRequest("update_readed",{lastReaded:e.lastReadedId})))})},makeRequest:function(e,t){var s=this;"undefined"==typeof t&&(t={}),clearInterval(s.timer),s.timer=null;try{switch(e){case"new_msg":t.operation="new_msg",$.post(this.setting.ajaxUrl,t,function(e){e.error?s.insertMessage('<span class="text-danger">'+e.error+"</span>",3):(s.lastMsgId=e.message_id,s.insertMessage(e.text,e.initiator,e.date_added),$(".lh-textarea-input").focus(),s.playSound("msg_sent"))},"json");break;default:t.lastId=s.lastMsgId,$.post(this.setting.ajaxUrl,t,function(e){if(e.error)throw new Error(e.error);e.operator&&s.isOnline!=parseInt(e.operator[0].is_logged)&&s.changeOperatorState(parseInt(e.operator[0].is_logged));var t=0;if(e.messages){for(var a in e.messages){var n=e.messages[a];"1"!=n.initiator&&n.message_id>s.lastReadedId&&t++,s.insertMessage(n.text,parseInt(n.initiator),n.date_added)}t?(s.setNewStatus(s.newMessageCount+t),s.newMessageCount=s.newMessageCount+t):s.newMessageCount+t==0&&s.removeNewStatus(),s.lastMsgId=e.lastId}return parseInt(e.kicked)&&!s.stopTimer?(s.insertMessage('<span class="text-danger">'+s.getLang("error_kicked")+"</span>",3),void(s.stopTimer=1)):void 0},"json")}}catch(a){console.log(a)}this.startTimer()},insertMessage:function(e,t,s){var a,n="",i="";switch(t){case 1:a="sent",i=this.getLang("text_me");break;case 2:a="received",i=this.temp.operator;break;default:a="bot-generated"}n+='<div class="msg msg-'+a+'">',(s||i)&&(n+=' <div class="msg-head">',i&&(n+=' <span class="msg-author">'+i+"</span>"),s&&(n+=' <span class="msg-date">'+s+"</span>"),n+=" </div>"),n+=' <div class="msg-body">',n+=e.replace("\n","<br>"),n+=" </div>",n+="</div>",$(".lh-messages").append(n),this.setting.customSlider&&this.recalcSlideBar(),this.scrollToBottom()},insertAction:function(e,t){},logout:function(){$.post(this.setting.ajaxUrl,{operation:"signout"},function(){location.reload()},"json")},setNewStatus:function(e){$("#livehelp").addClass("lh-active-box"),$("#livehelp").find(".lh-badge").html('<span class="badge-box">'+e+"</span>"||""),this.playSound("new_msg"),this.setting.titleAlert&&this.setPageTitleAlert(e)},removeNewStatus:function(){$("#livehelp").removeClass("lh-active-box"),$("#livehelp").find(".lh-badge").html(""),this.setting.titleAlert&&this.breakPageTitleAlert()},changeOperatorState:function(e){e?(this.insertMessage(this.getLang("text_operator_online_again"),3),this.playSound("op_join")):(this.insertMessage(this.getLang("text_operator_away"),3),this.playSound("op_leave")),this.isOnline=e},changeTextareaHeight:function(e){var t=parseInt(e.css("height"));74>t&&e.css("height",t+20+"px")},insertText:function(e){var t=$(".lh-textarea-input"),s=this.caretPos(t),a=t.val().substring(0,s),n=t.val().substring(s);t.val(a+" "+e+" "+n),t.focus(),$(".lh-smiley-plugin, .lh-bbcode-plugin").popover("hide")},insertBBCode:function(e){var t=this;switch(e){case"url":str=prompt(t.getLang("text_entry_url"),"http://"),str&&t.insertText("[url]"+str+"[/url]");break;case"youtube":str=prompt(t.getLang("text_entry_youtube"),"https://www.youtube.com/embed/"),str&&t.insertText("[youtube]"+str+"[/youtube]");break;default:this.insertText("["+e+"][/"+e+"]")}},clearText:function(e){e.val(""),e.css("height","34px")},caretPos:function(e){if("undefined"!=typeof e&&e.length){e=e[0];var t=0;if(document.selection){e.focus();var s=document.selection.createRange(),a=document.selection.createRange().text.length;s.moveStart("character",-e.value.length),t=s.text.length-a}else(e.selectionStart||"0"==e.selectionStart)&&(t=e.selectionStart);return t}},scrollToBottom:function(){this.setting.customSlider?this.setting.customSlider.simplebar("scrollTo",$(".lh-messages").height()):$(".lh-messages").get(0).scrollTop=$(".lh-messages").get(0).scrollHeight},loadSound:function(){var e=$("<audio></audio>");e.attr("id","lh-js-audio-block"),$("#livehelp").append(e)},playSound:function(e){if(this.setting.sound){$("#lh-js-audio-block").length||this.loadSound();var t=$("#lh-js-audio-block");try{switch(e){case"new_msg":if(!this.setting.soundAlert.newMessage)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.newMessage+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"msg_sent":if(!this.setting.soundAlert.messageSent)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.messageSent+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"op_join":case"op_switch":if(!this.setting.soundAlert.operatorJoin)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.operatorJoin+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"op_leave":if(!this.setting.soundAlert.operatorLeave)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.operatorLeave+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play();break;case"redirect":case"expirate":if(!this.setting.soundAlert.special)break;t.children("source").remove(),t.append('<source src="'+this.setting.soundFolder+this.setting.soundAlert.special+'" type="audio/mpeg">'),t.get(0).load(),t.get(0).play()}}catch(s){console.log(s)}}},toggleSound:function(e){e.preventDefault(),e.stopPropagation(),null===localStorage.getItem("sound")?this.setting.sound=0:this.setting.sound=1===parseInt(localStorage.getItem("sound"))?0:1,localStorage.setItem("sound",this.setting.sound),$(".lh-js-sound-toggle i").toggleClass("icon1-volume-high icon1-volume-mute")},recalcSlideBar:function(){this.setting.customSlider.simplebar("recalculate")},setPageTitleAlert:function(e){var t=this;t.pageTitleInterval=setInterval(function(){document.title.length>t.temp.page_title.length?document.title=t.temp.page_title:document.title="("+e+") "+t.temp.page_title},1500)},breakPageTitleAlert:function(){document.title=this.temp.page_title,clearInterval(this.pageTitleInterval),this.pageTitleInterval=null}};